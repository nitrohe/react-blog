/**
 * The MIT License (MIT)
 *
 * Copyright (c) 2017 Jakub Beneš <benes@webscope.io>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("react"),require("prop-types")):"function"==typeof define&&define.amd?define(["react","prop-types"],t):e.ReactTextareaAutocomplete=t(e.React,e.PropTypes)}(this,function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;var p=function(e,t){return t={exports:{}},e(t,t.exports),t.exports}(function(e){!function(){var t=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"],n="undefined"!=typeof window,r=n&&null!=window.mozInnerScreenX;e.exports=function(e,o,i){if(!n)throw new Error("textarea-caret-position#getCaretCoordinates should only be called in a browser");var a=i&&i.debug||!1;if(a){var s=document.querySelector("#input-textarea-caret-position-mirror-div");s&&s.parentNode.removeChild(s)}var l=document.createElement("div");l.id="input-textarea-caret-position-mirror-div",document.body.appendChild(l);var c=l.style,u=window.getComputedStyle?getComputedStyle(e):e.currentStyle;c.whiteSpace="pre-wrap","INPUT"!==e.nodeName&&(c.wordWrap="break-word"),c.position="absolute",a||(c.visibility="hidden"),t.forEach(function(e){c[e]=u[e]}),r?e.scrollHeight>parseInt(u.height)&&(c.overflowY="scroll"):c.overflow="hidden",l.textContent=e.value.substring(0,o),"INPUT"===e.nodeName&&(l.textContent=l.textContent.replace(/\s/g," "));var f=document.createElement("span");f.textContent=e.value.substring(o)||".",l.appendChild(f);var p={top:f.offsetTop+parseInt(u.borderTopWidth),left:f.offsetLeft+parseInt(u.borderLeftWidth)};return a?f.style.backgroundColor="#aaa":document.body.removeChild(l),p}}()}),d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},g={ESC:27,UP:38,DOWN:40,ENTER:13,TAB:9},h=new function e(){var t=this;n(this,e),this.startListen=function(){t.isListening||(document.addEventListener("keydown",t.f),t.isListening=!0)},this.stopListen=function(){document.removeEventListener("keydown",t.f),t.isListening=!1},this.add=function(e,n){var r=e;return"object"!==(void 0===r?"undefined":d(r))&&(r=[r]),t.listeners[t.index]={keyCode:r,fn:n},t.index+=1,t.index},this.remove=function(e){delete t.listeners[e],t.index-=1},this.removeAll=function(){t.listeners={},t.index=0},this.index=0,this.listeners={},this.isListening=!1,this.f=function(e){for(var n=e.keyCode||e.which,r=0;r<t.index;r+=1){var o=t.listeners[r],i=o.keyCode,a=o.fn;i.includes(n)&&a(e)}}},m=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),y=function(t){function n(){var e,t,i,a;r(this,n);for(var s=arguments.length,l=Array(s),c=0;c<s;c++)l[c]=arguments[c];return t=i=o(this,(e=n.__proto__||Object.getPrototypeOf(n)).call.apply(e,[this].concat(l))),i.selectItem=function(){var e=i.props,t=e.item;(0,e.onSelectHandler)(t)},a=t,o(i,a)}return i(n,e.Component),m(n,[{key:"render",value:function(){var t=this.props,n=t.component,r=t.style,o=t.onClickHandler,i=t.item,a=t.selected,s=t.className;return e.createElement("li",{className:"rta__item "+(s||""),style:r},e.createElement("div",{className:"rta__entity "+(!0===a?"rta__entity--selected":""),role:"button",tabIndex:0,onClick:o,onFocus:this.selectItem,onMouseEnter:this.selectItem},e.createElement(n,{selected:a,entity:i})))}}]),n}(),v=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),b=function(t){function n(){var e,t,r,o;a(this,n);for(var i=arguments.length,l=Array(i),c=0;c<i;c++)l[c]=arguments[c];return t=r=s(this,(e=n.__proto__||Object.getPrototypeOf(n)).call.apply(e,[this].concat(l))),r.state={selectedItem:null},r.onPressEnter=function(e){e.preventDefault();var t=r.props.values;r.modifyText(t[r.getPositionInList()])},r.getPositionInList=function(){var e=r.props.values,t=r.state.selectedItem;return t?e.findIndex(function(e){return r.getId(e)===r.getId(t)}):0},r.getId=function(e){return"string"!=typeof e&&e.key?e.key:r.props.getTextToReplace(e).text},r.listeners=[],r.modifyText=function(e){if(e){var t=r.props;(0,t.onSelect)((0,t.getTextToReplace)(e))}},r.selectItem=function(e){r.setState({selectedItem:e})},r.scroll=function(e){e.preventDefault();var t=r.props.values,n=e.keyCode||e.which,o=r.getPositionInList(),i=void 0;switch(n){case g.DOWN:i=o+1;break;case g.UP:i=o-1;break;default:i=o}i=(i%t.length+t.length)%t.length,r.setState({selectedItem:t[i]})},r.isSelected=function(e){var t=r.state.selectedItem;return!!t&&r.getId(t)===r.getId(e)},o=t,s(r,o)}return l(n,e.Component),v(n,[{key:"componentDidMount",value:function(){this.listeners.push(h.add([g.DOWN,g.UP],this.scroll),h.add([g.ENTER,g.TAB],this.onPressEnter));var e=this.props.values;e&&e[0]&&this.selectItem(e[0])}},{key:"componentWillReceiveProps",value:function(e){var t=e.values;t&&t[0]&&this.selectItem(t[0])}},{key:"componentWillUnmount",value:function(){for(var e=void 0;this.listeners.length;)e=this.listeners.pop(),h.remove(e)}},{key:"render",value:function(){var t=this,n=this.props,r=n.values,o=n.component,i=n.style,a=n.itemClassName,s=n.className,l=n.itemStyle;return e.createElement("ul",{className:"rta__list "+(s||""),style:i},r.map(function(n){return e.createElement(y,{key:t.getId(n),selected:t.isSelected(n),item:n,className:a,style:l,onClickHandler:t.onPressEnter,onSelectHandler:t.selectItem,component:o})}))}}]),n}(),w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},C=function(){function e(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){o=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(o)throw i}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),S=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),x=function(e){return console.error("RTA: dataProvider fails: "+e+"\n    \nCheck the documentation or create issue if you think it's bug. https://github.com/webscopeio/react-textarea-autocomplete/issues")},_=function(t){function n(e){c(this,n);var t=u(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));E.call(t),h.add(g.ESC,function(){return t._closeAutocomplete()});var r=t.props,o=r.loadingComponent,i=r.trigger,a=r.value;if(a&&(t.state.value=a),t._createRegExp(),!o)throw new Error("RTA: loadingComponent is not defined");if(!i)throw new Error("RTA: trigger is not defined");return t}return f(n,e.Component),S(n,[{key:"componentDidMount",value:function(){h.startListen()}},{key:"componentWillReceiveProps",value:function(e){this._update(e)}},{key:"componentWillUnmount",value:function(){h.stopListen()}},{key:"_update",value:function(e){var t=e.value,n=e.trigger,r=this.state.value,o=this.props.trigger;t===r&&r||this.setState({value:t}),Object.keys(n).join("")!==Object.keys(o).join("")&&this._createRegExp()}},{key:"render",value:function(){var t=this,n=this.props,r=n.loadingComponent,o=n.style,i=n.className,a=n.listStyle,s=n.itemStyle,l=n.listClassName,c=n.itemClassName,u=n.dropdownClassName,f=n.dropdownStyle,p=n.containerStyle,d=n.containerClassName,g=n.loaderStyle,h=n.loaderClassName,m=this.state,y=m.left,v=m.top,w=m.dataLoading,C=m.currentTrigger,S=m.component,x=m.value,_=this._getSuggestions(),E=this._getTextToReplace();return e.createElement("div",{className:"rta "+(!0===w?"rta--loading":"")+" "+(d||""),style:p},e.createElement("textarea",Object.assign({},this._cleanUpProps(),{ref:function(e){t.textareaRef=e},className:"rta__textarea "+(i||""),onChange:this._changeHandler,onSelect:this._selectHandler,onClick:this._onClickAndBlurHandler,onBlur:this._onClickAndBlurHandler,value:x,style:o})),(w||_)&&C&&e.createElement("div",{ref:function(e){t.dropdownRef=e},style:Object.assign({top:v,left:y},f),className:"rta__autocomplete "+(u||"")},_&&S&&E&&e.createElement(b,{values:_,component:S,style:a,className:l,itemClassName:c,itemStyle:s,getTextToReplace:E,onSelect:this._onSelect}),w&&e.createElement("div",{className:"rta__loader "+(null!==_?"rta__loader--suggestion-data":"rta__loader--empty-suggestion-data")+" "+(h||""),style:g},e.createElement(r,{data:_}))))}}]),n}();_.defaultProps={closeOnClickOutside:!1,movePopupAsYouType:!1,value:"",minChar:1};var E=function(){var e=this;this.state={top:null,left:null,currentTrigger:null,actualToken:"",data:null,value:"",dataLoading:!1,selectionEnd:0,selectionStart:0,component:null},this.getSelectionPosition=function(){return e.textareaRef?{selectionStart:e.textareaRef.selectionStart,selectionEnd:e.textareaRef.selectionEnd}:null},this.getSelectedText=function(){if(!e.textareaRef)return null;var t=e.textareaRef,n=t.selectionStart,r=t.selectionEnd;return n===r?null:e.state.value.substr(n,r-n)},this.setCaretPosition=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;e.textareaRef&&(e.textareaRef.focus(),e.textareaRef.setSelectionRange(t,t))},this.getCaretPosition=function(){return e.textareaRef?e.textareaRef.selectionEnd:0},this._onSelect=function(t){var n=e.state,r=n.selectionEnd,o=n.currentTrigger,i=n.value,a=e.props,s=a.onChange,l=a.trigger;if(o){var c=i.slice(0,r),u=c.search(new RegExp("\\"+o+(l[o].allowWhitespace?".":"\\S")+"*$")),f="next"===t.caretPosition?t.text+" ":t.text,p=function(e,t,n){switch(e){case"start":return n;case"next":case"end":return n+t.length;default:if(!Number.isInteger(e))throw new Error('RTA: caretPosition should be "start", "next", "end" or number.');return e}}(t.caretPosition,f,u),d=c.substring(0,u)+f;e.setState({value:i.replace(c,d),dataLoading:!1},function(){var t=new Event("change",{bubbles:!0});e.textareaRef.dispatchEvent(t),s&&s(t),e.setCaretPosition(p)}),e._closeAutocomplete()}},this._getTextToReplace=function(){var t=e.state,n=t.currentTrigger,r=t.actualToken,o=e._getCurrentTriggerSettings();if(!n||!o)return null;var i=o.output;return function(e){if("object"===(void 0===e?"undefined":w(e))&&(!i||"function"!=typeof i))throw new Error('Output functor is not defined! If you are using items as object you have to define "output" function. https://github.com/webscopeio/react-textarea-autocomplete#trigger-type');if(i){var t=i(e,n);if(!t||"number"==typeof t)throw new Error('Output functor should return string or object in shape {text: string, caretPosition: string | number}.\nGot "'+String(t)+'". Check the implementation for trigger "'+n+'" and its token "'+r+'"\n\nSee https://github.com/webscopeio/react-textarea-autocomplete#trigger-type for more informations.\n');if("string"==typeof t)return{text:t,caretPosition:"next"};if(!t.text)throw new Error('Output "text" is not defined! Object should has shape {text: string, caretPosition: string | number}. Check the implementation for trigger "'+n+'" and its token "'+r+'"\n');if(!t.caretPosition)throw new Error('Output "caretPosition" is not defined! Object should has shape {text: string, caretPosition: string | number}. Check the implementation for trigger "'+n+'" and its token "'+r+'"\n');return t}if("string"!=typeof e)throw new Error("Output item should be string\n");return{text:""+n+e+n,caretPosition:"next"}}},this._getCurrentTriggerSettings=function(){var t=e.state.currentTrigger;return t?e.props.trigger[t]:null},this._getValuesFromProvider=function(){var t=e.state,n=t.currentTrigger,r=t.actualToken,o=e._getCurrentTriggerSettings();if(n&&o){var i=o.dataProvider,a=o.component;if("function"!=typeof i)throw new Error("Trigger provider has to be a function!");e.setState({dataLoading:!0});var s=i(r);s instanceof Promise||(s=Promise.resolve(s)),s.then(function(t){if(!Array.isArray(t))throw new Error("Trigger provider has to provide an array!");if("function"!=typeof a)throw new Error("Component should be defined!");n===e.state.currentTrigger&&e.setState({dataLoading:!1,data:t,component:a})}).catch(function(e){return x(e.message)})}},this._getSuggestions=function(){var t=e.state,n=t.currentTrigger,r=t.data;return!n||!r||r&&!r.length?null:r},this._createRegExp=function(){var t=e.props.trigger;e.tokenRegExp=new RegExp("["+Object.keys(t).join("")+"][^\\s]*$")},this._closeAutocomplete=function(){e.setState({data:null,dataLoading:!1,currentTrigger:null,top:null,left:null})},this._cleanUpProps=function(){var t=Object.assign({},e.props),n=["loadingComponent","containerStyle","minChar","ref","onChange","onCaretPositionChange","className","value","trigger","listStyle","itemStyle","containerStyle","loaderStyle","className","containerClassName","listClassName","itemClassName","loaderClassName","closeOnClickOutside","dropdownStyle","dropdownClassName","movePopupAsYouType"];for(var r in t)n.includes(r)&&delete t[r];return t},this._changeHandler=function(t){var n=e.props,r=n.trigger,o=n.onChange,i=n.minChar,a=n.onCaretPositionChange,s=n.movePopupAsYouType,l=e.state,c=l.top,u=l.left,f=t.target,d=f.selectionEnd,g=f.selectionStart,h=f.value;o&&(t.persist(),o(t)),a&&a(e.getCaretPosition()),e.setState({value:h});var m=e.tokenRegExp.exec(h.slice(0,d)),y=m&&m[0],v=y&&Object.keys(r).find(function(e){return e===y[0]})||null;if(y&&!(y.length<=i)||(!e.state.currentTrigger||r[e.state.currentTrigger].allowWhitespace)&&e.state.currentTrigger)if(v&&h[m.index-1]&&r[v].afterWhitespace&&!h[m.index-1].match(/\s/))e._closeAutocomplete();else{if(e.state.currentTrigger&&r[e.state.currentTrigger].allowWhitespace){if(m=new RegExp("\\"+e.state.currentTrigger+"[^"+e.state.currentTrigger+"]*$").exec(h.slice(0,d)),!(y=m&&m[0]))return void e._closeAutocomplete();v=Object.keys(r).find(function(e){return e===y[0]})||null}var b=y.slice(1);v&&((s||null===c&&null===u)&&e.setState(p(f,d)),e.setState({selectionEnd:d,selectionStart:g,currentTrigger:v,actualToken:b},function(){try{e._getValuesFromProvider()}catch(e){x(e.message)}}))}else e._closeAutocomplete()},this._selectHandler=function(t){var n=e.props,r=n.onCaretPositionChange,o=n.onSelect;r&&r(e.getCaretPosition()),o&&(t.persist(),o(t))},this._onClickAndBlurHandler=function(t){var n=e.props,r=n.closeOnClickOutside,o=n.onBlur,i=t.relatedTarget;e.dropdownRef&&i instanceof Node&&e.dropdownRef.contains(i)||(r&&e._closeAutocomplete(),o&&(t.persist(),o(t)))}};return _.propTypes={loadingComponent:t.func.isRequired,minChar:t.number,onChange:t.func,onSelect:t.func,onBlur:t.func,onCaretPositionChange:t.func,className:t.string,containerStyle:t.object,containerClassName:t.string,closeOnClickOutside:t.bool,style:t.object,listStyle:t.object,itemStyle:t.object,loaderStyle:t.object,dropdownStyle:t.object,listClassName:t.string,itemClassName:t.string,loaderClassName:t.string,dropdownClassName:t.string,value:t.string,trigger:function(e){var t=e.trigger;if(!t)return Error("Invalid prop trigger. Prop missing.");for(var n=Object.entries(t),r=0;r<n.length;r+=1){var o=C(n[r],2),i=o[0],a=o[1];if("string"!=typeof i||1!==i.length)return Error("Invalid prop trigger. Keys of the object has to be string / one character.");var s=a,l=s.component,c=s.dataProvider,u=s.output,f=s.afterWhitespace,p=s.allowWhitespace;if(!l||"function"!=typeof l)return Error("Invalid prop trigger: component should be defined.");if(!c||"function"!=typeof c)return Error("Invalid prop trigger: dataProvider should be defined.");if(u&&"function"!=typeof u)return Error("Invalid prop trigger: output should be a function.");if(f&&p)return Error("Invalid prop trigger: afterWhitespace and allowWhitespace can be used together")}return null}},_});
